#!/bin/bash

# Pre-commit hook to run static checks in parallel

PASS=TRUE

# Enable/disable specific checks
#TODO: Add more checks here.
RUN_CSPELL="TRUE"
RUN_MARKDOWNLINT="TRUE"
RUN_PRETTIER="TRUE"

# Create local temp directory for output capture
TMPDIR=".tmp"
if [ ! -d "$TMPDIR" ]; then
    mkdir -p "$TMPDIR"
    echo "*" > "$TMPDIR/.gitignore"
fi

#TODO: Define temp files for each check's output
CSPELL_OUT=$(mktemp -p "$TMPDIR")
MARKDOWNLINT_OUT=$(mktemp -p "$TMPDIR")
PRETTIER_OUT=$(mktemp -p "$TMPDIR")


# TODO: add output file to the cleqnup trap 
# Cleanup temp files on exit
trap "rm -f $CSPELL_OUT $MARKDOWNLINT_OUT $PRETTIER_OUT" EXIT

echo "üîç Running pre-commit checks..."

# Track how many progress lines we print
PROGRESS_COUNT=0


#TODO: Add more checks here 
# Start checks in parallel
if [ "$RUN_CSPELL" == "TRUE" ]; then
    printf "   ‚è≥ CSpell check\n"
    ((PROGRESS_COUNT++))
    cspell . > "$CSPELL_OUT" 2>&1 &
    CSPELL_PID=$!
fi

if [ "$RUN_MARKDOWNLINT" == "TRUE" ]; then
    printf "   ‚è≥ MarkdownLint check\n"
    ((PROGRESS_COUNT++))
    markdownlint-cli2 > "$MARKDOWNLINT_OUT" 2>&1 &
    MARKDOWNLINT_PID=$!
fi

if [ "$RUN_PRETTIER" == "TRUE" ]; then
    printf "   ‚è≥ Prettier check\n"
    ((PROGRESS_COUNT++))
    prettier --check "**/*.{md,html,css,js,json}" > "$PRETTIER_OUT" 2>&1 &
    PRETTIER_PID=$!
fi


# TODO Set initial status variables for each check

CSPELL_STATUS=0
MARKDOWNLINT_STATUS=0
PRETTIER_STATUS=0

#  TODO: Wait for checks to complete and capture their exit statuses

if [ "$RUN_CSPELL" == "TRUE" ]; then
    wait $CSPELL_PID || CSPELL_STATUS=$?
    if [ $CSPELL_STATUS -eq 0 ]; then
        echo "   ‚úÖ CSpell check"
    else
        echo "   ‚ùå CSpell check"
        PASS=FALSE
    fi
fi

if [ "$RUN_MARKDOWNLINT" == "TRUE" ]; then
    wait $MARKDOWNLINT_PID || MARKDOWNLINT_STATUS=$?
    if [ $MARKDOWNLINT_STATUS -eq 0 ]; then
        echo "   ‚úÖ MarkdownLint check"
    else
        echo "   ‚ùå MarkdownLint check"
        PASS=FALSE
    fi
fi

if [ "$RUN_PRETTIER" == "TRUE" ]; then
    wait $PRETTIER_PID || PRETTIER_STATUS=$?
    if [ $PRETTIER_STATUS -eq 0 ]; then
        echo "   ‚úÖ Prettier check"
    else
        echo "   ‚ùå Prettier check"
        PASS=FALSE
    fi
fi

# Clear progress lines and replace with results
for ((i=0; i<PROGRESS_COUNT; i++)); do
    tput cuu 1  # Move cursor up one line
    tput el     # Clear line
done

# Move back to start of progress section
tput cuu $PROGRESS_COUNT

# TODO Print final status for each check

# Print final status for each check
if [ "$RUN_CSPELL" == "TRUE" ]; then
    if [ $CSPELL_STATUS -eq 0 ]; then
        echo "   ‚úÖ CSpell check"
    else
        echo "   ‚ùå CSpell check"
    fi
fi

if [ "$RUN_MARKDOWNLINT" == "TRUE" ]; then
    if [ $MARKDOWNLINT_STATUS -eq 0 ]; then
        echo "   ‚úÖ MarkdownLint check"
    else
        echo "   ‚ùå MarkdownLint check"
    fi
fi

if [ "$RUN_PRETTIER" == "TRUE" ]; then
    if [ $PRETTIER_STATUS -eq 0 ]; then
        echo "   ‚úÖ Prettier check"
    else
        echo "   ‚ùå Prettier check"
    fi
fi


# Report results
if [ "$PASS" == "TRUE" ]; then
    echo ""
    echo "‚úÖ All pre-commit checks passed"
    exit 0
else

    # TODO Print detailed output for failed checks. 
    
    echo ""
    if [ $CSPELL_STATUS -ne 0 ]; then
        echo "CSpell issues:"
        cat "$CSPELL_OUT"
        echo ""
    fi
    if [ $MARKDOWNLINT_STATUS -ne 0 ]; then
        echo "MarkdownLint issues:"
        cat "$MARKDOWNLINT_OUT"
        echo ""
    fi
    if [ $PRETTIER_STATUS -ne 0 ]; then
        echo "Prettier issues:"
        cat "$PRETTIER_OUT"
        echo ""
    fi

    echo "üëâ Fix the issues above before committing."
    echo "üí° You can run the same checks manually with: '.githooks/pre-commit'"
    exit 1
fi
